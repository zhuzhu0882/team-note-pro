<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»åº”ç”¨è¯Šæ–­ - Team Note Pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .diagnostic-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Team Note Pro ä¸»åº”ç”¨è¯Šæ–­</h1>

    <div class="diagnostic-section">
        <h2>ğŸ“ æ–‡ä»¶åŠ è½½æ£€æŸ¥</h2>
        <div id="file-check"></div>
        <button onclick="checkFiles()">é‡æ–°æ£€æŸ¥æ–‡ä»¶</button>
    </div>

    <div class="diagnostic-section">
        <h2>ğŸ”¥ Firebase è¿æ¥æ£€æŸ¥</h2>
        <div id="firebase-check"></div>
        <button onclick="checkFirebase()">æ£€æŸ¥ Firebase</button>
    </div>

    <div class="diagnostic-section">
        <h2>ğŸ“± JavaScript åŠ è½½æ£€æŸ¥</h2>
        <div id="js-check"></div>
        <button onclick="checkJavaScript()">æ£€æŸ¥ JavaScript</button>
    </div>

    <div class="diagnostic-section">
        <h2>ğŸ¨ CSS æ ·å¼æ£€æŸ¥</h2>
        <div id="css-check"></div>
        <button onclick="checkCSS()">æ£€æŸ¥ CSS</button>
    </div>

    <div class="diagnostic-section">
        <h2>ğŸ”§ å°è¯•åŠ è½½ä¸»åº”ç”¨</h2>
        <div id="app-load-check"></div>
        <button onclick="loadMainApp()">å°è¯•åŠ è½½ä¸»åº”ç”¨</button>
    </div>

    <div class="diagnostic-section">
        <h2>ğŸ“„ å®æ—¶æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="log" class="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>

    <script>
        let logContainer = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            logContainer.textContent += entry + '\n';
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(entry);
        }

        function clearLog() {
            logContainer.textContent = '';
        }

        function updateSection(sectionId, content, type = 'info') {
            const section = document.getElementById(sectionId);
            section.innerHTML = `<div class="status ${type}">${content}</div>`;
        }

        // æ£€æŸ¥æ–‡ä»¶åŠ è½½
        function checkFiles() {
            log('å¼€å§‹æ£€æŸ¥æ–‡ä»¶åŠ è½½...');

            const files = [
                'css/style.css',
                'mobile-fix.css',
                'js/firebase-config.js',
                'js/storage-firebase.js',
                'js/app-firebase.js'
            ];

            let results = [];
            let completed = 0;

            files.forEach(file => {
                fetch(file, { method: 'HEAD' })
                    .then(response => {
                        completed++;
                        const status = response.ok ? 'âœ…' : 'âŒ';
                        results.push(`${status} ${file} (${response.status})`);

                        if (completed === files.length) {
                            updateSection('file-check', results.join('<br>'),
                                results.some(r => r.includes('âŒ')) ? 'error' : 'success');
                            log('æ–‡ä»¶æ£€æŸ¥å®Œæˆ');
                        }
                    })
                    .catch(error => {
                        completed++;
                        results.push(`âŒ ${file} (åŠ è½½å¤±è´¥: ${error.message})`);

                        if (completed === files.length) {
                            updateSection('file-check', results.join('<br>'), 'error');
                            log('æ–‡ä»¶æ£€æŸ¥å®Œæˆï¼Œæœ‰é”™è¯¯');
                        }
                    });
            });
        }

        // æ£€æŸ¥ Firebase
        function checkFirebase() {
            log('å¼€å§‹æ£€æŸ¥ Firebase...');

            try {
                if (typeof firebase === 'undefined') {
                    updateSection('firebase-check', 'âŒ Firebase SDK æœªåŠ è½½', 'error');
                    log('Firebase SDK æœªåŠ è½½');
                    return;
                }

                const firebaseConfig = {
                    apiKey: "AIzaSyCiUK6B4HCSHD3jGpcfRwbd81RxEtCO-l4",
                    authDomain: "team-note-pro.firebaseapp.com",
                    projectId: "team-note-pro",
                    storageBucket: "team-note-pro.appspot.com",
                    messagingSenderId: "475394331627",
                    appId: "1:475394331627:web:placeholder_app_id"
                };

                firebase.initializeApp(firebaseConfig);

                const auth = firebase.auth();
                const db = firebase.firestore();

                updateSection('firebase-check',
                    'âœ… Firebase SDK å·²åŠ è½½<br>âœ… Firebase åˆå§‹åŒ–æˆåŠŸ<br>âœ… Auth æœåŠ¡å¯ç”¨<br>âœ… Firestore æœåŠ¡å¯ç”¨',
                    'success');

                log('Firebase æ£€æŸ¥æˆåŠŸ');

                // æµ‹è¯•æ•°æ®åº“è¿æ¥
                db.collection('test').doc('diagnostic').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: 'diagnostic-test'
                }).then(() => {
                    log('âœ… Firestore å†™å…¥æµ‹è¯•æˆåŠŸ');
                    return db.collection('test').doc('diagnostic').delete();
                }).then(() => {
                    log('âœ… Firestore è¿æ¥æµ‹è¯•å®Œæˆ');
                }).catch(error => {
                    log(`âŒ Firestore æµ‹è¯•å¤±è´¥: ${error.message}`);
                });

            } catch (error) {
                updateSection('firebase-check', `âŒ Firebase åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                log(`Firebase åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        }

        // æ£€æŸ¥ JavaScript
        function checkJavaScript() {
            log('å¼€å§‹æ£€æŸ¥ JavaScript æ–‡ä»¶...');

            const scripts = [
                'js/firebase-config.js',
                'js/storage-firebase.js',
                'js/app-firebase.js'
            ];

            let results = [];
            let loadedCount = 0;

            scripts.forEach(script => {
                const scriptElement = document.createElement('script');
                scriptElement.src = script;

                scriptElement.onload = () => {
                    loadedCount++;
                    results.push(`âœ… ${script} åŠ è½½æˆåŠŸ`);

                    if (loadedCount === scripts.length) {
                        updateSection('js-check', results.join('<br>'), 'success');
                        log('JavaScript æ–‡ä»¶æ£€æŸ¥å®Œæˆ');

                        // æ£€æŸ¥å…¨å±€å¯¹è±¡
                        setTimeout(() => {
                            if (window.FirebaseUtils) {
                                log('âœ… FirebaseUtils å…¨å±€å¯¹è±¡å¯ç”¨');
                            } else {
                                log('âŒ FirebaseUtils å…¨å±€å¯¹è±¡ä¸å¯ç”¨');
                            }

                            if (window.noteApp) {
                                log('âœ… noteApp å…¨å±€å¯¹è±¡å¯ç”¨');
                            } else {
                                log('âŒ noteApp å…¨å±€å¯¹è±¡ä¸å¯ç”¨');
                            }
                        }, 1000);
                    }
                };

                scriptElement.onerror = () => {
                    loadedCount++;
                    results.push(`âŒ ${script} åŠ è½½å¤±è´¥`);

                    if (loadedCount === scripts.length) {
                        updateSection('js-check', results.join('<br>'), 'error');
                        log('JavaScript æ–‡ä»¶æ£€æŸ¥å®Œæˆï¼Œæœ‰é”™è¯¯');
                    }
                };

                document.head.appendChild(scriptElement);
            });
        }

        // æ£€æŸ¥ CSS
        function checkCSS() {
            log('å¼€å§‹æ£€æŸ¥ CSS æ–‡ä»¶...');

            const links = [
                'css/style.css',
                'mobile-fix.css'
            ];

            let results = [];
            let completed = 0;

            links.forEach(css => {
                fetch(css)
                    .then(response => {
                        completed++;
                        const status = response.ok ? 'âœ…' : 'âŒ';
                        results.push(`${status} ${css} (${response.status}, ${response.headers.get('content-length')} bytes)`);

                        if (completed === links.length) {
                            updateSection('css-check', results.join('<br>'),
                                results.some(r => r.includes('âŒ')) ? 'error' : 'success');
                            log('CSS æ£€æŸ¥å®Œæˆ');
                        }
                    })
                    .catch(error => {
                        completed++;
                        results.push(`âŒ ${css} (åŠ è½½å¤±è´¥: ${error.message})`);

                        if (completed === links.length) {
                            updateSection('css-check', results.join('<br>'), 'error');
                            log('CSS æ£€æŸ¥å®Œæˆï¼Œæœ‰é”™è¯¯');
                        }
                    });
            });
        }

        // å°è¯•åŠ è½½ä¸»åº”ç”¨
        function loadMainApp() {
            log('å°è¯•åŠ è½½ä¸»åº”ç”¨...');

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä¸»åº”ç”¨çš„HTMLç»“æ„
            fetch('index.html')
                .then(response => response.text())
                .then(html => {
                    if (html.includes('æˆ‘çš„ç¬”è®° - Team Note Pro')) {
                        updateSection('app-load-check',
                            'âœ… ä¸»åº”ç”¨ HTML æ–‡ä»¶å¯è®¿é—®<br>ğŸ”„ å°è¯•åœ¨å½“å‰é¡µé¢åŠ è½½ä¸»åº”ç”¨...',
                            'info');

                        // åˆ›å»ºä¸€ä¸ªiframeæ¥æµ‹è¯•ä¸»åº”ç”¨
                        const iframe = document.createElement('iframe');
                        iframe.src = 'index.html';
                        iframe.style.width = '100%';
                        iframe.style.height = '500px';
                        iframe.style.border = '1px solid #ddd';
                        iframe.style.borderRadius = '8px';

                        const container = document.getElementById('app-load-check');
                        container.innerHTML = '<h3>ä¸»åº”ç”¨é¢„è§ˆï¼š</h3>';
                        container.appendChild(iframe);

                        log('ä¸»åº”ç”¨ iframe å·²åˆ›å»º');
                    } else {
                        updateSection('app-load-check', 'âŒ ä¸»åº”ç”¨ HTML æ–‡ä»¶å†…å®¹å¼‚å¸¸', 'error');
                        log('ä¸»åº”ç”¨ HTML å†…å®¹å¼‚å¸¸');
                    }
                })
                .catch(error => {
                    updateSection('app-load-check', `âŒ æ— æ³•åŠ è½½ä¸»åº”ç”¨ HTML: ${error.message}`, 'error');
                    log(`æ— æ³•åŠ è½½ä¸»åº”ç”¨: ${error.message}`);
                });
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.addEventListener('load', () => {
            log('è¯Šæ–­é¡µé¢åŠ è½½å®Œæˆ');
            log('å¼€å§‹è‡ªåŠ¨è¯Šæ–­...');

            setTimeout(() => {
                checkFiles();
            }, 500);

            setTimeout(() => {
                checkFirebase();
            }, 1000);

            setTimeout(() => {
                checkCSS();
            }, 1500);
        });

        // é”™è¯¯ç›‘å¬
        window.addEventListener('error', (e) => {
            log(`âŒ é¡µé¢é”™è¯¯: ${e.error.message} at ${e.filename}:${e.lineno}`);
        });

        window.addEventListener('unhandledrejection', (e) => {
            log(`âŒ Promise é”™è¯¯: ${e.reason}`);
        });
    </script>
</body>
</html>