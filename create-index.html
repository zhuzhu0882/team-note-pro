<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建 Firestore 索引 - Team Note Pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .link-button {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .link-button:hover {
            background: #0056b3;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 创建 Firestore 数据库索引</h1>

        <div class="warning">
            <strong>⚠️ 注意：</strong> 您的应用需要创建一个 Firestore 索引才能正常工作。这个过程只需要一次。
        </div>

        <h2>📋 问题说明</h2>
        <p>您的笔记应用需要按用户ID和更新时间排序查询笔记。Firestore 需要为此创建一个复合索引。</p>

        <h2>🚀 解决方案</h2>

        <div class="step">
            <h3>方法一：自动创建（推荐）</h3>
            <p>点击下面的按钮，Firebase 会自动检测并提示创建所需的索引：</p>

            <a href="https://console.firebase.google.com/v1/r/project/team-note-pro/firestore/indexes?create_composite=Cktwcm9qZWN0cy90ZWFtLW5vdGUtcHJvL2RhdGFiYXNlcy8oZGVmYXVsdCkvY29sbGVjdGlvbkdyb3Vwcy9ub3Rlcy9pbmRleGVzL18QARoHCgN1aWQQARoNCgl1cGRhdGVkQXQQAhoMCghfX25hbWVfXxAC"
               target="_blank"
               class="link-button">
                📱 自动创建 Firestore 索引
            </a>

            <p><strong>操作步骤：</strong></p>
            <ol>
                <li>点击上面的按钮打开 Firebase 控制台</li>
                <li>登录您的 Google 账号（如果需要）</li>
                <li>确认项目是 "team-note-pro"</li>
                <li>点击"创建索引"按钮</li>
                <li>等待索引创建完成（通常需要几分钟）</li>
            </ol>
        </div>

        <div class="step">
            <h3>方法二：手动创建</h3>
            <p>如果上面的链接不工作，您可以手动创建索引：</p>

            <ol>
                <li>访问 <a href="https://console.firebase.google.com/project/team-note-pro/firestore" target="_blank">Firebase 控制台</a></li>
                <li>选择 "team-note-pro" 项目</li>
                <li>进入 Firestore 数据库</li>
                <li>点击 "索引" 标签页</li>
                <li>点击"添加索引"按钮</li>
                <li>填写以下信息：</li>
            </ol>

            <div class="code">
                <strong>集合ID：</strong> notes<br>
                <strong>字段：</strong><br>
                - uid (升序)<br>
                - updatedAt (降序)<br>
                <strong>查询范围：</strong> 集合<br>
                <strong>索引名称：</strong> notes_uid_updatedAt (自动生成)
            </div>
        </div>

        <div class="step">
            <h3>✅ 验证索引创建</h3>
            <p>创建索引后，返回您的应用并刷新页面。应用应该能正常加载笔记列表了。</p>

            <p>您也可以访问测试页面验证：</p>
            <a href="/simple-app.html" class="link-button">📝 打开简化版应用</a>
        </div>

        <div class="success">
            <strong>💡 提示：</strong> 索引创建是一次性操作。创建完成后，您的应用就能正常工作了，无需重复此步骤。
        </div>

        <h2>🔍 故障排除</h2>

        <div class="step">
            <h3>如果仍有问题：</h3>
            <ol>
                <li>等待几分钟让索引完全生效</li>
                <li>清除浏览器缓存并刷新页面</li>
                <li>检查您是否有足够的 Firebase 权限</li>
                <li>确认选择了正确的项目（team-note-pro）</li>
                <li>查看浏览器控制台的错误信息</li>
            </ol>
        </div>

        <div class="step">
            <h3>临时解决方案：</h3>
            <p>如果无法立即创建索引，应用会自动使用客户端排序作为临时解决方案。这可能会影响性能，但功能仍然可用。</p>
        </div>
    </div>

    <script>
        // 检查索引状态
        async function checkIndexStatus() {
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyCiUK6B4HCSHD3jGpcfRwbd81RxEtCO-l4",
                    authDomain: "team-note-pro.firebaseapp.com",
                    projectId: "team-note-pro",
                    storageBucket: "team-note-pro.appspot.com",
                    messagingSenderId: "475394331627",
                    appId: "1:475394331627:web:placeholder_app_id"
                };

                firebase.initializeApp(firebaseConfig);
                const db = firebase.firestore();

                // 尝试查询来检查索引是否存在
                try {
                    await db
                        .collection('notes')
                        .where('uid', '==', 'test')
                        .orderBy('updatedAt', 'desc')
                        .limit(1)
                        .get();

                    document.querySelector('.success').innerHTML +=
                        '<p><strong>✅ 索引检查：</strong> 索引已存在，应用应该能正常工作！</p>';
                } catch (error) {
                    if (error.message.includes('requires an index')) {
                        document.querySelector('.warning').innerHTML +=
                            '<p><strong>❌ 索引检查：</strong> 索引尚未创建，请按照上面的步骤创建。</p>';
                    }
                }
            } catch (error) {
                console.log('无法检查索引状态:', error);
            }
        }

        // 页面加载完成后检查索引状态
        window.addEventListener('load', checkIndexStatus);
    </script>

    <!-- Firebase SDK for index checking -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</body>
</html>