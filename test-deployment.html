<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨ç½²æµ‹è¯• - Team Note Pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ Team Note Pro éƒ¨ç½²æµ‹è¯•</h1>

    <div class="info">
        <strong>æµ‹è¯•è¯´æ˜ï¼š</strong> è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•åº”ç”¨éƒ¨ç½²åçš„åŠŸèƒ½æ˜¯å¦æ­£å¸¸
    </div>

    <div style="margin: 20px 0;">
        <button onclick="testFirebaseConnection()">æµ‹è¯• Firebase è¿æ¥</button>
        <button onclick="testUserAuth()">æµ‹è¯•ç”¨æˆ·è®¤è¯</button>
        <button onclick="testFirestore()">æµ‹è¯• Firestore æ•°æ®åº“</button>
        <button onclick="testAppLoading()">æµ‹è¯•åº”ç”¨åŠ è½½</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
    </div>

    <div id="results">
        <div class="info">
            <strong>å‡†å¤‡å°±ç»ªï¼</strong> ç‚¹å‡»ä¸Šé¢çš„æŒ‰é’®å¼€å§‹æµ‹è¯•...
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            addResult('æµ‹è¯•ç»“æœå·²æ¸…é™¤', 'info');
        }

        function testFirebaseConnection() {
            addResult('å¼€å§‹æµ‹è¯• Firebase è¿æ¥...', 'info');

            try {
                // æµ‹è¯• Firebase åˆå§‹åŒ–
                if (typeof firebase !== 'undefined') {
                    addResult('âœ… Firebase SDK åŠ è½½æˆåŠŸ', 'success');

                    // æµ‹è¯•é¡¹ç›®é…ç½®
                    const projectId = firebase.app().options.projectId;
                    if (projectId === 'team-note-pro') {
                        addResult(`âœ… é¡¹ç›®é…ç½®æ­£ç¡®: ${projectId}`, 'success');
                    } else {
                        addResult(`âŒ é¡¹ç›®é…ç½®é”™è¯¯: ${projectId}`, 'error');
                    }

                    // æµ‹è¯•æœåŠ¡åˆå§‹åŒ–
                    const auth = firebase.auth();
                    const db = firebase.firestore();
                    const storage = firebase.storage();

                    addResult('âœ… Firebase æœåŠ¡åˆå§‹åŒ–æˆåŠŸ', 'success');
                    addResult(`âœ… Auth æœåŠ¡: ${typeof auth}`, 'success');
                    addResult(`âœ… Firestore æœåŠ¡: ${typeof db}`, 'success');
                    addResult(`âœ… Storage æœåŠ¡: ${typeof storage}`, 'success');

                } else {
                    addResult('âŒ Firebase SDK æœªåŠ è½½', 'error');
                }
            } catch (error) {
                addResult(`âŒ Firebase è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testUserAuth() {
            addResult('å¼€å§‹æµ‹è¯•ç”¨æˆ·è®¤è¯...', 'info');

            try {
                const auth = firebase.auth();

                // æµ‹è¯•å½“å‰ç”¨æˆ·çŠ¶æ€
                const user = auth.currentUser;
                if (user) {
                    addResult(`âœ… ç”¨æˆ·å·²ç™»å½•: ${user.email}`, 'success');
                } else {
                    addResult('â„¹ï¸ å½“å‰æœªç™»å½•ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰', 'info');
                }

                // æµ‹è¯•è®¤è¯çŠ¶æ€ç›‘å¬
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        addResult(`âœ… è®¤è¯çŠ¶æ€ç›‘å¬æ­£å¸¸ï¼Œç”¨æˆ·: ${user.email}`, 'success');
                    } else {
                        addResult('âœ… è®¤è¯çŠ¶æ€ç›‘å¬æ­£å¸¸ï¼Œç”¨æˆ·æœªç™»å½•', 'success');
                    }
                });

                addResult('âœ… ç”¨æˆ·è®¤è¯åŠŸèƒ½æ­£å¸¸', 'success');

            } catch (error) {
                addResult(`âŒ ç”¨æˆ·è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testFirestore() {
            addResult('å¼€å§‹æµ‹è¯• Firestore æ•°æ®åº“...', 'info');

            try {
                const db = firebase.firestore();

                // æµ‹è¯•æ•°æ®åº“è¿æ¥
                const testRef = db.collection('test').doc('connection-test');

                testRef.set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: 'deployment-test'
                }).then(() => {
                    addResult('âœ… Firestore å†™å…¥æµ‹è¯•æˆåŠŸ', 'success');

                    // æµ‹è¯•è¯»å–
                    return testRef.get();
                }).then((doc) => {
                    if (doc.exists) {
                        addResult('âœ… Firestore è¯»å–æµ‹è¯•æˆåŠŸ', 'success');
                        addResult(`âœ… æµ‹è¯•æ•°æ®: ${JSON.stringify(doc.data())}`, 'success');

                        // æ¸…ç†æµ‹è¯•æ•°æ®
                        return testRef.delete();
                    } else {
                        addResult('âŒ æµ‹è¯•æ•°æ®ä¸å­˜åœ¨', 'error');
                    }
                }).then(() => {
                    addResult('âœ… æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ', 'success');
                    addResult('âœ… Firestore æ•°æ®åº“åŠŸèƒ½å®Œå…¨æ­£å¸¸', 'success');
                }).catch((error) => {
                    addResult(`âŒ Firestore æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                });

            } catch (error) {
                addResult(`âŒ Firestore æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testAppLoading() {
            addResult('å¼€å§‹æµ‹è¯•åº”ç”¨åŠ è½½...', 'info');

            // æµ‹è¯•ä¸»è¦ JavaScript æ–‡ä»¶
            const scripts = [
                'js/firebase-config.js',
                'js/storage-firebase.js',
                'js/app-firebase.js'
            ];

            let loadedCount = 0;

            scripts.forEach(script => {
                const scriptElement = document.createElement('script');
                scriptElement.src = script;
                scriptElement.onload = () => {
                    loadedCount++;
                    addResult(`âœ… ${script} åŠ è½½æˆåŠŸ`, 'success');

                    if (loadedCount === scripts.length) {
                        addResult('âœ… æ‰€æœ‰æ ¸å¿ƒ JavaScript æ–‡ä»¶åŠ è½½å®Œæˆ', 'success');

                        // æµ‹è¯•å…¨å±€å¯¹è±¡
                        setTimeout(() => {
                            if (window.FirebaseUtils) {
                                addResult('âœ… FirebaseUtils å…¨å±€å¯¹è±¡å¯ç”¨', 'success');

                                // æµ‹è¯• FirebaseUtils çš„åŠŸèƒ½
                                if (window.FirebaseUtils.auth && window.FirebaseUtils.db) {
                                    addResult('âœ… Firebase è®¤è¯å’Œæ•°æ®åº“æœåŠ¡å¯ç”¨', 'success');
                                } else {
                                    addResult('âŒ Firebase æœåŠ¡ä¸å¯ç”¨', 'error');
                                }
                            } else {
                                addResult('âŒ FirebaseUtils å…¨å±€å¯¹è±¡ä¸å¯ç”¨', 'error');
                            }

                            if (window.noteApp) {
                                addResult('âœ… noteApp å…¨å±€å¯¹è±¡å¯ç”¨', 'success');
                                addResult(`âœ… å½“å‰ç”¨æˆ·çŠ¶æ€: ${window.noteApp.currentUser ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`, 'success');

                                // æµ‹è¯•åº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½
                                if (window.noteApp.storage) {
                                    addResult('âœ… å­˜å‚¨ç®¡ç†å™¨å·²åˆå§‹åŒ–', 'success');
                                    const syncStatus = window.noteApp.storage.getSyncStatus();
                                    addResult(`âœ… åŒæ­¥çŠ¶æ€: ${syncStatus.syncMode}`, 'success');
                                }

                                // æµ‹è¯•æŒ‰é’®äº‹ä»¶ç»‘å®š
                                if (window.noteApp.newNoteBtn) {
                                    addResult('âœ… æ–°å»ºç¬”è®°æŒ‰é’®å·²æ‰¾åˆ°', 'success');
                                } else {
                                    addResult('âŒ æ–°å»ºç¬”è®°æŒ‰é’®æœªæ‰¾åˆ°', 'error');
                                }

                            } else {
                                addResult('â„¹ï¸ noteApp å…¨å±€å¯¹è±¡æœªåˆå§‹åŒ–ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºåœ¨æµ‹è¯•é¡µé¢ä¸­', 'info');
                            }
                        }, 2000); // ç­‰å¾…2ç§’è®©åº”ç”¨å®Œå…¨åˆå§‹åŒ–
                    }
                };
                scriptElement.onerror = () => {
                    addResult(`âŒ ${script} åŠ è½½å¤±è´¥`, 'error');
                };
                document.head.appendChild(scriptElement);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...', 'info');
                testFirebaseConnection();
            }, 1000);
        });
    </script>
</body>
</html>